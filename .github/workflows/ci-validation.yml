name: CI - Security & Kubernetes Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          exit-code: 0  # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å workflow –ø—Ä–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç—è—Ö
          format: 'table'  # –ü—Ä–æ—Å—Ç–æ–π –≤—ã–≤–æ–¥ –≤ –ª–æ–≥
          output: 'trivy-results.txt'

      - name: Show Trivy results
        if: always()
        run: |
          if [ -f "trivy-results.txt" ]; then
            echo "=== Trivy Scan Results ==="
            cat trivy-results.txt
          else
            echo "No Trivy results file found"
          fi

      - name: Scan Dockerfile
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          exit-code: 0
          format: 'table'

  k8s-validate:
    name: Kubernetes Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.30.0'  # –∏–ª–∏ latest

      - name: Validate Kubernetes manifests (dry-run)
        run: |
          echo "üîç Validating Kubernetes YAML manifests..."

          # –ù–∞–π—Ç–∏ –≤—Å–µ .yaml, –∏—Å–∫–ª—é—á–∞—è —Å–µ–∫—Ä–µ—Ç—ã, –±–∏–Ω–∞—Ä–Ω–∏–∫–∏, values –∏ –Ω–µ-K8s —Ñ–∞–π–ª—ã
          while IFS= read -r -d '' file; do
            echo "‚úÖ Validating $file"
            kubectl apply --dry-run=client -f "$file" --validate=false
          done < <(find . -name "*.yaml" \
                     -not -path "./secret/*" \
                     -not -path "./velero/credentials-velero" \
                     -not -path "*/kgctl-*" \
                     -not -name "*values.yaml" \
                     -not -name "*peer*.yaml" \
                     -not -name "k3s.yaml" \
                     -print0)

          echo "‚úÖ All Kubernetes manifests passed dry-run validation"